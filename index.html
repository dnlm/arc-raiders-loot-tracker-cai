<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arc Raiders Loot Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .last-updated {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .workbench-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .reset-button {
            grid-column: 1 / -1;
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .reset-button:hover {
            background: #c82333;
        }

        .workbench-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .workbench-item label {
            font-weight: 600;
            color: #495057;
            flex: 1;
        }

        .workbench-item select {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
        }

        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-recycle {
            background: #d4edda;
            color: #155724;
        }

        .badge-sell {
            background: #fff3cd;
            color: #856404;
        }

        .badge-needed {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-equal {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-rarity {
            font-size: 11px;
            padding: 3px 8px;
        }

        .rarity-common {
            background: #e9ecef;
            color: #495057;
        }

        .rarity-uncommon {
            background: #d4edda;
            color: #155724;
        }

        .rarity-rare {
            background: #cce5ff;
            color: #004085;
        }

        .rarity-epic {
            background: #e7d4f5;
            color: #6f42c1;
        }

        .rarity-legendary {
            background: #fff3cd;
            color: #856404;
        }

        .price {
            font-weight: 600;
            color: #28a745;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #667eea;
        }

        .item-name {
            font-weight: 600;
            color: #667eea;
            text-decoration: none;
        }

        .item-name:hover {
            text-decoration: underline;
        }

        .recycle-info {
            font-size: 12px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .controls {
                padding: 20px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŽ® Arc Raiders Loot Tracker</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </header>

        <div class="controls">
            <input 
                type="text" 
                id="searchBox" 
                class="search-box" 
                placeholder="ðŸ” Search items by name..."
            >

            <div class="workbench-settings" id="workbenchSettings">
                <!-- Workbench controls will be dynamically added -->
            </div>
            <button class="reset-button" id="resetButton">Reset All Workbench Levels</button>
        </div>

        <div class="table-container">
            <div class="loading" id="loading">Loading loot data...</div>
            <table id="lootTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Rarity</th>
                        <th>Category</th>
                        <th>Sell Price</th>
                        <th>Recycles To</th>
                        <th>Recycled Value</th>
                        <th>Recommendation</th>
                        <th>Workbench Status</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let lootData = [];
        let workbenches = {};
        const WORKBENCH_TYPES = ['Gunsmith', 'Gear Bench', 'Medical Lab', 'Explosives', 'Utility', 'Refiner', 'Scrappy'];

        const WORKBENCH_RECIPES = {
            gunsmith: {
                0: [],
                1: ['Metal Parts', 'Rubber Parts'], // Build: 20 Metal Parts, 30 Rubber Parts
                2: ['Rusted Tools', 'Mechanical Components', 'Wasp Driver'], // L1->L2: 3 Rusted Tools, 5 Mechanical Components, 8 Wasp Drivers
                3: ['Rusted Gear', 'Advanced Mechanical Components', 'Sentinel Firing Core'] // L2->L3
            },
            gear_bench: {
                0: [],
                1: ['Fabric', 'Plastic Parts'], // Build: 50 Fabric, 6 ARC Alloy
                2: ['Electrical Components', 'Power Cable', 'Hornet Driver'], // L1->L2: Electrical Components mentioned
                3: ['Industrial Battery', 'Advanced Electrical Components', 'Bastion Cell'] // L2->L3
            },
            medical_lab: {
                0: [],
                1: ['Fabric', 'ARC Alloy'], // Build: 50 Fabric, 6 ARC Alloy (same as Gear)
                2: ['Cracked Bioscanner', 'Durable Cloth', 'Tick Pod'], // L1->L2: 8 Syringes, 5 Antiseptic, 3 Snitch Scanners
                3: ['Rusted Shut Medical Kit', 'Antiseptic', 'Surveyor Vault'] // L2->L3
            },
            explosives: {
                0: [],
                1: ['Chemicals', 'ARC Alloy'], // Build: 25 Plastic Parts, 30 Fabric
                2: ['Synthesized Fuel', 'Crude Explosives', 'Pop Trigger'], // L1->L2: 3 Power Cables, 5 Electrical Components, 5 Hornet Drivers
                3: ['Laboratory Reagents', 'Explosive Compound', 'Rocketeer Driver'] // L2->L3
            },
            utility: {
                0: [],
                1: ['Plastic Parts', 'ARC Alloy'], // Build: 50 Plastic Parts, 6 ARC Alloy
                2: ['Damaged Heat Sink', 'Electrical Components', 'Snitch Scanner'], // L1->L2: 2 Damaged Heat Sink, 5 Electrical Components, 6 Snitch Scanners
                3: ['Fried Motherboard', 'Advanced Electrical Components', 'Leaper Pulse Unit'] // L2->L3
            },
            refiner: {
                0: [],
                1: ['Metal Parts', 'ARC Powercell'], // Build: 75 Metal Parts, 3 ARC Motion Cores
                2: ['Toaster', 'ARC Motion Core', 'Fireball Burner'], // L1->L2: Toasters mentioned
                3: ['Motor', 'ARC Circuitry', 'Bombardier Cell'] // L2->L3
            },
            scrappy: {
                0: [],
                1: ['Dog Collar'], // L0->L1 (Level 2): 1 Dog Collar
                2: ['Lemon', 'Apricot'], // L1->L2 (Level 3): 3 Lemons, 3 Apricots
                3: ['Prickly Pear', 'Olives', 'Cat Bed'], // L2->L3 (Level 4): 8 Prickly Pears, 8 Olives, 1 Cat Bed
                4: ['Mushroom', 'Apricot', 'Very Comfortable Pillow'], // L3->L4 (Level 5)
            }
        };

        function loadWorkbenchLevels() {
            // Read persisted levels from localStorage and sanitize them.
            const raw = localStorage.getItem('workbenchLevels');
            const defaults = {};

            // Build default map based on WORKBENCH_TYPES -> 0
            WORKBENCH_TYPES.forEach(t => {
                const key = t.toLowerCase().replace(/ /g, '_');
                defaults[key] = 0;
            });

            if (!raw) return defaults;

            try {
                const parsed = JSON.parse(raw) || {};
                const levels = {};

                // Only keep known benches and coerce to allowed range [0..3]
                Object.keys(defaults).forEach(key => {
                    const maxL = getMaxLevel(key);
                    const n = Number(parsed[key]);
                    levels[key] = Number.isInteger(n) && n >= 0 && n <= maxL ? n : 0;
                });


                return levels;
            } catch {
                // If storage is corrupted, start fresh
                return defaults;
            }
        }

        function saveWorkbenchLevels() {
            // Persist the current `workbenches` map
            try {
                localStorage.setItem('workbenchLevels', JSON.stringify(workbenches));
            } catch {
                // ignore quota or serialization errors
            }
        }

        function resetWorkbenchLevels() {
            // Reset internal state
            WORKBENCH_TYPES.forEach(t => {
                const key = t.toLowerCase().replace(/ /g, '_');
                workbenches[key] = 0;
            });

            // Update all selects in the UI
            WORKBENCH_TYPES.forEach(t => {
                const key = t.toLowerCase().replace(/ /g, '_');
                const sel = document.getElementById(`workbench-${key}`);
                if (sel) sel.value = '0';
            });

            // Persist & re-render
            saveWorkbenchLevels();
            renderTable();
        }


        async function loadData() {
            try {
                const response = await fetch('data/loot-data.json');
                const data = await response.json();
                lootData = data.items;
                
                document.getElementById('lastUpdated').textContent = 
                    `Last Updated: ${new Date(data.lastUpdated).toLocaleString()}`;
                
                initWorkbenchSettings();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lootTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').textContent = 
                    'Error loading data. Please try again later.';
            }
        }

        function getMaxLevel(typeKey) {
            const levels = WORKBENCH_RECIPES[typeKey];
            if (!levels) return 3; // sane fallback
            return Math.max(...Object.keys(levels).map(n => parseInt(n, 10)));
        }


        function initWorkbenchSettings() {
            const container = document.getElementById('workbenchSettings');
            
            // Load saved levels
            const savedLevels = loadWorkbenchLevels();
            
            WORKBENCH_TYPES.forEach(type => {
                const div = document.createElement('div');
                div.className = 'workbench-item';
                
                const label = document.createElement('label');
                label.textContent = `${type}:`;
                
                const select = document.createElement('select');
                const typeKey = type.toLowerCase().replace(/ /g, '_');
                select.id = `workbench-${typeKey}`;
                
                const option0 = document.createElement('option');
                option0.value = '0';
                option0.textContent = 'Not Built';
                select.appendChild(option0);

                const maxL = getMaxLevel(typeKey);
                for (let i = 1; i <= maxL; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Level ${i}`;
                    select.appendChild(option);
                }

                
                // Set saved value or default to 0
                const savedValue = savedLevels[typeKey] || 0;
                select.value = savedValue;
                workbenches[typeKey] = savedValue;
                
                select.addEventListener('change', (e) => {
                    workbenches[typeKey] = parseInt(e.target.value);
                    saveWorkbenchLevels();
                    renderTable();
                });
                
                div.appendChild(label);
                div.appendChild(select);
                container.appendChild(div);
            });
            
            // Setup reset button
            document.getElementById('resetButton').addEventListener('click', resetWorkbenchLevels);
        }

        function isItemNeededForWorkbench(itemName) {
            // Check each workbench type
            for (const [type, levels] of Object.entries(WORKBENCH_RECIPES)) {
                const currentLevel = workbenches[type];

                const nextLevel = currentLevel + 1;
                const maxL = getMaxLevel(type);
                
                // Check if this item is needed for the next level upgrade
                if (nextLevel <= maxL && levels[nextLevel]) {
                    // Check if item name matches any required items (fuzzy match)
                    for (const reqItem of levels[nextLevel]) {
                        // Try various matching strategies
                        if (itemName.toLowerCase().includes(reqItem.toLowerCase()) || 
                            reqItem.toLowerCase().includes(itemName.toLowerCase()) ||
                            itemName.toLowerCase().replace(/\s+/g, '') === reqItem.toLowerCase().replace(/\s+/g, '')) {
                            // Format bench name nicely
                            let benchName = type.replace(/_/g, ' ').split(' ')
                                .map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                            return {
                                needed: true,
                                bench: benchName,
                                level: nextLevel
                            };
                        }
                    }
                }
            }
            
            return { needed: false };
        }

        function getRecommendation(item) {
            if (!item.sellPrice) return { action: 'Unknown', class: 'badge-equal' };
            
            if (!item.recycledSellPrice || item.recycledSellPrice === 0) {
                return { action: 'Sell', class: 'badge-sell' };
            }
            
            if (item.recycledSellPrice > item.sellPrice) {
                return { action: 'Recycle', class: 'badge-recycle' };
            } else if (item.recycledSellPrice < item.sellPrice) {
                return { action: 'Sell', class: 'badge-sell' };
            } else {
                return { action: 'Equal', class: 'badge-equal' };
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            tbody.innerHTML = '';
            
            const filteredData = lootData.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredData.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 8;
                cell.innerHTML = '<div class="no-data">No items found</div>';
                return;
            }
            
            filteredData.forEach(item => {
                const row = tbody.insertRow();
                
                // Item name
                const nameCell = row.insertCell();
                const itemLink = item.link ? `${item.link}` : '#';
                nameCell.innerHTML = `<a href="https://arcraiders.wiki${item.link}" target="_blank" class="item-name">${item.name}</a>`;
                
                // Rarity
                const rarityCell = row.insertCell();
                const rarityClass = `rarity-${(item.rarity || 'common').toLowerCase()}`;
                rarityCell.innerHTML = `<span class="badge badge-rarity ${rarityClass}">${item.rarity || 'Unknown'}</span>`;
                
                // Category
                const categoryCell = row.insertCell();
                categoryCell.textContent = item.category || '-';
                
                // Sell price
                const priceCell = row.insertCell();
                priceCell.innerHTML = item.sellPrice 
                    ? `<span class="price">${item.sellPrice}</span>` 
                    : '-';
                
                // Recycles to
                const recycleCell = row.insertCell();
                if (item.recyclesToText && item.recyclesToText !== '-') {
                    recycleCell.innerHTML = `<div class="recycle-info">${item.recyclesToText}</div>`;
                } else {
                    recycleCell.textContent = '-';
                }
                
                // Recycled value
                const recycledValueCell = row.insertCell();
                recycledValueCell.innerHTML = item.recycledSellPrice 
                    ? `<span class="price">${item.recycledSellPrice}</span>` 
                    : '-';
                
                // Recommendation
                const recommendationCell = row.insertCell();
                const rec = getRecommendation(item);
                recommendationCell.innerHTML = `<span class="badge ${rec.class}">${rec.action}</span>`;
                
                // Workbench status
                const workbenchCell = row.insertCell();
                const neededInfo = isItemNeededForWorkbench(item.name);
                if (neededInfo.needed) {
                    workbenchCell.innerHTML = `<span class="badge badge-needed">${neededInfo.bench} L${neededInfo.level}</span>`;
                } else {
                    workbenchCell.textContent = '-';
                }
            });
        }

        // Event listeners
        document.getElementById('searchBox').addEventListener('input', renderTable);

        // Initialize
        loadData();
    </script>
</body>
</html>
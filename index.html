<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arc Raiders Loot Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #000;
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(60deg,
                /* ===== Red band ‚Üí black (stripe 1 around 25%) ===== */
                rgb(241, 10, 9) 0%,
                rgb(241, 10, 9) 21.7%,
                color-mix(in srgb, rgb(241, 10, 9) 70%, black 30%) 22.2%,
                color-mix(in srgb, rgb(241, 10, 9) 30%, black 70%) 22.5%,
                black 22.5%,
                black 27.5%,
                color-mix(in srgb, rgb(247, 211, 13) 30%, black 70%) 27.8%,
                color-mix(in srgb, rgb(247, 211, 13) 70%, black 30%) 28.3%,

                /* ===== Yellow band ===== */
                rgb(247, 211, 13) 28.8%,
                rgb(247, 211, 13) 46.7%,
                color-mix(in srgb, rgb(247, 211, 13) 70%, black 30%) 47.2%,
                color-mix(in srgb, rgb(247, 211, 13) 30%, black 70%) 47.5%,
                black 47.5%,
                black 52.5%,
                color-mix(in srgb, rgb(46, 238, 126) 30%, black 70%) 52.8%,
                color-mix(in srgb, rgb(46, 238, 126) 70%, black 30%) 53.3%,

                /* ===== Green band ===== */
                rgb(46, 238, 126) 53.8%,
                rgb(46, 238, 126) 71.7%,
                color-mix(in srgb, rgb(46, 238, 126) 70%, black 30%) 72.2%,
                color-mix(in srgb, rgb(46, 238, 126) 30%, black 70%) 72.5%,
                black 72.5%,
                black 77.5%,
                color-mix(in srgb, rgb(129, 240, 228) 30%, black 70%) 77.8%,
                color-mix(in srgb, rgb(129, 240, 228) 70%, black 30%) 78.3%,

                /* ===== Cyan band ===== */
                rgb(129, 240, 228) 78.8%,
                rgb(129, 240, 228) 100%
            );
            color: white;
            padding: 30px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .last-updated {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-wrapper {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }

        .search-label {
            font-size: 13px;
            font-weight: 600;
            color: #6c757d;
            padding-left: 5px;
        }

        .search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 10px 40px 10px 16px;
            font-size: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            transition: border-color 0.3s;
            width: 100%;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .clear-search {
            position: absolute;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1;
            padding: 0;
            transition: background 0.2s;
        }

        .clear-search:hover {
            background: #495057;
        }

        .clear-search.visible {
            display: flex;
        }

        @media (max-width: 768px) {
            .search-container {
                grid-template-columns: 1fr;
            }
        }

        .workbench-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        .settings-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .section-header {
            color: #495057;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .section-header:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .section-header .chevron {
            transition: transform 0.3s ease;
            font-size: 0.8em;
        }

        .section-header.collapsed .chevron {
            transform: rotate(-90deg);
        }

        .workbench-section {
            margin-bottom: 20px;
        }

        .subsection-header {
            color: #495057;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subsection-header:first-child {
            margin-top: 0;
        }

        .expedition-section {
            margin-top: 5px;
        }

        .expedition-content {
            overflow: visible;
        }

        .expedition-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .expedition-phase-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .expedition-phase-selector label {
            font-weight: 600;
            color: #495057;
        }

        .expedition-phase-selector select {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .reset-button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            width: 100%;
        }

        .reset-button:hover {
            background: #c82333;
        }

        .workbench-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .workbench-item label {
            font-weight: 600;
            color: #495057;
            flex: 1;
        }

        .workbench-item select {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
        }

        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 5px;
        }

        .badge-recycle {
            background: #d4edda;
            color: #155724;
        }

        .badge-sell {
            background: #fff3cd;
            color: #856404;
        }

        .badge-needed {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-expedition {
            background: #cfe2ff;
            color: #084298;
        }

        .badge-quest {
            background: #d1e7dd;
            color: #0f5132;
        }

        .badge-equal {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-rarity {
            font-size: 11px;
            padding: 3px 8px;
        }

        .rarity-common {
            background: #e9ecef;
            color: #495057;
        }

        .rarity-uncommon {
            background: #d4edda;
            color: #155724;
        }

        .rarity-rare {
            background: #cce5ff;
            color: #004085;
        }

        .rarity-epic {
            background: #e7d4f5;
            color: #6f42c1;
        }

        .rarity-legendary {
            background: #fff3cd;
            color: #856404;
        }

        .price {
            font-weight: 600;
            color: #28a745;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #667eea;
        }

        .item-name {
            font-weight: 600;
            color: #667eea;
            text-decoration: none;
        }

        .item-name:hover {
            text-decoration: underline;
        }

        .recycle-info {
            font-size: 12px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .controls {
                padding: 20px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 6px;
            }
        }

        footer {
            background: #f8f9fa;
            padding: 20px 30px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            border-top: 2px solid #e9ecef;
        }

        footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .footer-separator {
            margin: 0 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ Arc Raiders Loot Tracker</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </header>

        <div class="controls">
            <div class="search-container">
                <div class="search-wrapper">
                    <label class="search-label" for="itemSearchBox">üîç Search by Item Name</label>
                    <div class="search-input-container">
                        <input 
                            type="text" 
                            id="itemSearchBox" 
                            class="search-input" 
                            placeholder="e.g., Battery, Metal Parts..."
                        >
                        <button class="clear-search" id="clearItemSearch" title="Clear search">‚úï</button>
                    </div>
                </div>
                <div class="search-wrapper">
                    <label class="search-label" for="recycleSearchBox">‚ôªÔ∏è Search by Recycles To</label>
                    <div class="search-input-container">
                        <input 
                            type="text" 
                            id="recycleSearchBox" 
                            class="search-input" 
                            placeholder="e.g., Steel Spring, Wires..."
                        >
                        <button class="clear-search" id="clearRecycleSearch" title="Clear search">‚úï</button>
                    </div>
                </div>
            </div>

            <h3 class="section-header" id="settingsHeader">
                <span class="chevron">‚ñº</span>
                ‚öôÔ∏è Settings
            </h3>
            <div class="settings-content" id="settingsContent">
                <div class="workbench-section">
                    <h4 class="subsection-header">
                        üîß Workbench Upgrades
                    </h4>
                    <div class="workbench-settings" id="workbenchSettings">
                        <!-- Workbench controls will be dynamically added -->
                    </div>
                </div>

                <div class="expedition-section">
                    <h4 class="subsection-header">
                        üöÄ Expedition Progress
                    </h4>
                    <div class="expedition-content" id="expeditionContent">
                        <div class="expedition-phase-selector">
                            <label for="expeditionPhase">Current Phase Completed:</label>
                            <select id="expeditionPhase">
                                <option value="0">Not Started</option>
                                <option value="1">Phase 1: Foundation</option>
                                <option value="2">Phase 2: Core Systems</option>
                                <option value="3">Phase 3: Framework</option>
                                <option value="4">Phase 4: Outfitting</option>
                                <option value="5">Phase 5: Load Stage (Complete)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="reset-button" id="resetButton">Reset All Settings</button>
            </div>
        </div>

        <div class="table-container">
            <div class="loading" id="loading">Loading loot data...</div>
            <table id="lootTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Rarity</th>
                        <th>Category</th>
                        <th>Sell Price</th>
                        <th>Recycles To</th>
                        <th>Recycled Value</th>
                        <th>Recommendation</th>
                        <th>Keep For</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <footer>
            <div style="margin-bottom: 10px;">
                Data sourced from <a href="https://arcraiders.wiki/wiki/Loot" target="_blank" rel="noopener">Arc Raiders Wiki</a>
                <span class="footer-separator">‚Ä¢</span>
                <span id="footerLastUpdated">Updated automatically every 24 hours</span>
            </div>
            <div>
                <a href="https://arctracker.io/projects" target="_blank" rel="noopener">Expedition Info</a>
                <span class="footer-separator">‚Ä¢</span>
                <a href="https://patchcrazy.co.uk/all-arc-raiders-quest-list-rewards-objectives-and-locations/" target="_blank" rel="noopener">Quest Info</a>
                <span class="footer-separator">‚Ä¢</span>
                <a href="https://arcraiders.wiki/wiki/Badges" target="_blank" rel="noopener">Badges</a>
            </div>
        </footer>
    </div>

    <script>
        let lootData = [];
        let workbenches = {};
        let expeditionPhase = 0;
        const WORKBENCH_TYPES = ['Gunsmith', 'Gear Bench', 'Medical Lab', 'Explosives', 'Utility', 'Refiner', 'Scrappy'];

        const WORKBENCH_RECIPES = {
            gunsmith: {
                0: [],
                1: ['Metal Parts', 'Rubber Parts'], // Build: 20 Metal Parts, 30 Rubber Parts
                2: ['Rusted Tools', 'Mechanical Components', 'Wasp Driver'], // L1->L2: 3 Rusted Tools, 5 Mechanical Components, 8 Wasp Drivers
                3: ['Rusted Gear', 'Advanced Mechanical Components', 'Sentinel Firing Core'] // L2->L3
            },
            gear_bench: {
                0: [],
                1: ['Fabric', 'Plastic Parts'], // Build: 50 Fabric, 6 ARC Alloy
                2: ['Electrical Components', 'Power Cable', 'Hornet Driver'], // L1->L2: Electrical Components mentioned
                3: ['Industrial Battery', 'Advanced Electrical Components', 'Bastion Cell'] // L2->L3
            },
            medical_lab: {
                0: [],
                1: ['Fabric', 'ARC Alloy'], // Build: 50 Fabric, 6 ARC Alloy (same as Gear)
                2: ['Cracked Bioscanner', 'Durable Cloth', 'Tick Pod'], // L1->L2: 8 Syringes, 5 Antiseptic, 3 Snitch Scanners
                3: ['Rusted Shut Medical Kit', 'Antiseptic', 'Surveyor Vault'] // L2->L3
            },
            explosives: {
                0: [],
                1: ['Chemicals', 'ARC Alloy'], // Build: 25 Plastic Parts, 30 Fabric
                2: ['Synthesized Fuel', 'Crude Explosives', 'Pop Trigger'], // L1->L2: 3 Power Cables, 5 Electrical Components, 5 Hornet Drivers
                3: ['Laboratory Reagents', 'Explosive Compound', 'Rocketeer Driver'] // L2->L3
            },
            utility: {
                0: [],
                1: ['Plastic Parts', 'ARC Alloy'], // Build: 50 Plastic Parts, 6 ARC Alloy
                2: ['Damaged Heat Sink', 'Electrical Components', 'Snitch Scanner'], // L1->L2: 2 Damaged Heat Sink, 5 Electrical Components, 6 Snitch Scanners
                3: ['Fried Motherboard', 'Advanced Electrical Components', 'Leaper Pulse Unit'] // L2->L3
            },
            refiner: {
                0: [],
                1: ['Metal Parts', 'ARC Powercell'], // Build: 75 Metal Parts, 3 ARC Motion Cores
                2: ['Toaster', 'ARC Motion Core', 'Fireball Burner'], // L1->L2: Toasters mentioned
                3: ['Motor', 'ARC Circuitry', 'Bombardier Cell'] // L2->L3
            },
            scrappy: {
                0: [],
                1: ['Dog Collar'], // L0->L1 (Level 2): 1 Dog Collar
                2: ['Lemon', 'Apricot'], // L1->L2 (Level 3): 3 Lemons, 3 Apricots
                3: ['Prickly Pear', 'Olives', 'Cat Bed'], // L2->L3 (Level 4): 8 Prickly Pears, 8 Olives, 1 Cat Bed
                4: ['Mushroom', 'Apricot', 'Very Comfortable Pillow'], // L3->L4 (Level 5)
            }
        };

        const EXPEDITION_PHASES = {
            1: ['Metal Parts', 'Rubber Parts', 'ARC Alloy', 'Steel Spring'],
            2: ['Durable Cloth', 'Wires', 'Electrical Components', 'Cooling Fan'],
            3: ['Light Bulb', 'Battery', 'Sensors', 'Exodus Modules'],
            4: ['Humidifier', 'Advanced Electrical Components', 'Magnetic Accelerator', 'Leaper Pulse Unit'],
            5: [] // Phase 5 is coin value based, no specific items
        };

        function loadWorkbenchLevels() {
            // Read persisted levels from localStorage and sanitize them.
            const raw = localStorage.getItem('workbenchLevels');
            const defaults = {};

            // Build default map based on WORKBENCH_TYPES -> 0
            WORKBENCH_TYPES.forEach(t => {
                const key = t.toLowerCase().replace(/ /g, '_');
                defaults[key] = 0;
            });

            if (!raw) return defaults;

            try {
                const parsed = JSON.parse(raw) || {};
                const levels = {};

                // Only keep known benches and coerce to allowed range [0..3]
                Object.keys(defaults).forEach(key => {
                    const maxL = getMaxLevel(key);
                    const n = Number(parsed[key]);
                    levels[key] = Number.isInteger(n) && n >= 0 && n <= maxL ? n : 0;
                });

                return levels;
            } catch {
                // If storage is corrupted, start fresh
                return defaults;
            }
        }

        function loadExpeditionPhase() {
            const raw = localStorage.getItem('expeditionPhase');
            if (!raw) return 0;
            
            try {
                const phase = parseInt(raw, 10);
                return (phase >= 0 && phase <= 5) ? phase : 0;
            } catch {
                return 0;
            }
        }

        function saveWorkbenchLevels() {
            // Persist the current `workbenches` map
            try {
                localStorage.setItem('workbenchLevels', JSON.stringify(workbenches));
            } catch {
                // ignore quota or serialization errors
            }
        }

        function saveExpeditionPhase() {
            try {
                localStorage.setItem('expeditionPhase', expeditionPhase.toString());
            } catch {
                // ignore quota or serialization errors
            }
        }

        function loadSectionStates() {
            const raw = localStorage.getItem('sectionStates');
            if (!raw) return { settings: false };
            
            try {
                const states = JSON.parse(raw);
                return {
                    settings: states.settings === true
                };
            } catch {
                return { settings: false };
            }
        }

        function saveSectionStates(settingsCollapsed) {
            try {
                localStorage.setItem('sectionStates', JSON.stringify({
                    settings: settingsCollapsed
                }));
            } catch {
                // ignore quota or serialization errors
            }
        }

        function resetWorkbenchLevels() {
            // Reset internal state
            WORKBENCH_TYPES.forEach(t => {
                const key = t.toLowerCase().replace(/ /g, '_');
                workbenches[key] = 0;
            });

            // Update all selects in the UI
            WORKBENCH_TYPES.forEach(t => {
                const key = t.toLowerCase().replace(/ /g, '_');
                const sel = document.getElementById(`workbench-${key}`);
                if (sel) sel.value = '0';
            });

            // Reset expedition
            expeditionPhase = 0;
            const expSel = document.getElementById('expeditionPhase');
            if (expSel) expSel.value = '0';

            // Persist & re-render
            saveWorkbenchLevels();
            saveExpeditionPhase();
            renderTable();
        }


        async function loadData() {
            try {
                const response = await fetch('data/loot-data.json');
                const data = await response.json();
                lootData = data.items;
                
                const lastUpdated = new Date(data.lastUpdated).toLocaleString();
                document.getElementById('lastUpdated').textContent = 
                    `Last Updated: ${lastUpdated}`;
                document.getElementById('footerLastUpdated').textContent = 
                    `Last Updated: ${lastUpdated}`;
                
                initWorkbenchSettings();
                initExpeditionSettings();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lootTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').textContent = 
                    'Error loading data. Please try again later.';
            }
        }

        function getMaxLevel(typeKey) {
            const levels = WORKBENCH_RECIPES[typeKey];
            if (!levels) return 3; // sane fallback
            return Math.max(...Object.keys(levels).map(n => parseInt(n, 10)));
        }

        function initWorkbenchSettings() {
            const container = document.getElementById('workbenchSettings');
            
            // Load saved levels
            const savedLevels = loadWorkbenchLevels();
            
            WORKBENCH_TYPES.forEach(type => {
                const div = document.createElement('div');
                div.className = 'workbench-item';
                
                const label = document.createElement('label');
                label.textContent = `${type}:`;
                
                const select = document.createElement('select');
                const typeKey = type.toLowerCase().replace(/ /g, '_');
                select.id = `workbench-${typeKey}`;
                
                const option0 = document.createElement('option');
                option0.value = '0';
                option0.textContent = 'Not Built';
                select.appendChild(option0);

                const maxL = getMaxLevel(typeKey);
                for (let i = 1; i <= maxL; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Level ${i}`;
                    select.appendChild(option);
                }

                
                // Set saved value or default to 0
                const savedValue = savedLevels[typeKey] || 0;
                select.value = savedValue;
                workbenches[typeKey] = savedValue;
                
                select.addEventListener('change', (e) => {
                    workbenches[typeKey] = parseInt(e.target.value);
                    saveWorkbenchLevels();
                    renderTable();
                });
                
                div.appendChild(label);
                div.appendChild(select);
                container.appendChild(div);
            });
            
            // Setup reset button
            document.getElementById('resetButton').addEventListener('click', resetWorkbenchLevels);
        }

        function initExpeditionSettings() {
            // Load saved expedition phase
            expeditionPhase = loadExpeditionPhase();
            
            const select = document.getElementById('expeditionPhase');
            select.value = expeditionPhase.toString();
            
            select.addEventListener('change', (e) => {
                expeditionPhase = parseInt(e.target.value);
                saveExpeditionPhase();
                renderTable();
            });

            // Setup collapsible sections
            setupCollapsibleSections();
        }

        function setupCollapsibleSections() {
            // Load saved states
            const states = loadSectionStates();
            
            const settingsHeader = document.getElementById('settingsHeader');
            const settingsContent = document.getElementById('settingsContent');
            
            // Apply saved state
            if (states.settings) {
                settingsContent.classList.add('collapsed');
                settingsHeader.classList.add('collapsed');
            }
            
            // Settings section toggle
            settingsHeader.addEventListener('click', () => {
                const isCollapsed = settingsContent.classList.toggle('collapsed');
                settingsHeader.classList.toggle('collapsed');
                saveSectionStates(isCollapsed);
            });
        }

        function normalizeName(s) {
            // lower-case, strip all non-alphanumerics (spaces, hyphens, punctuation)
            // "Rocketeer Driver" -> "rocketeerdriver"
            // "ARC Power-Cell"   -> "arcpowercell"
            return (s || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        function isItemNeededForWorkbench(itemName) {
            for (const [type, levels] of Object.entries(WORKBENCH_RECIPES)) {
                const currentLevel = Number.isInteger(workbenches[type]) ? workbenches[type] : 0;
                const maxL = getMaxLevel(type);

                const itemNorm = normalizeName(itemName);

                // scan all future levels (current+1 ... maxL)
                for (let lvl = currentLevel + 1; lvl <= maxL; lvl++) {
                    const reqs = levels[lvl] || [];
                    for (const reqItem of reqs) {
                        if (itemNorm === normalizeName(reqItem)) {
                            const benchName = type.replace(/_/g, ' ')
                                .split(' ')
                                .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                                .join(' ');
                            return { needed: true, bench: benchName, level: lvl };
                        }
                    }
                }
            }
            return { needed: false };
        }

        function isItemNeededForExpedition(itemName) {
            const itemNorm = normalizeName(itemName);
            
            // Check all future phases (current+1 ... 5)
            for (let phase = expeditionPhase + 1; phase <= 5; phase++) {
                const reqs = EXPEDITION_PHASES[phase] || [];
                for (const reqItem of reqs) {
                    if (itemNorm === normalizeName(reqItem)) {
                        return { needed: true, phase: phase };
                    }
                }
            }
            
            return { needed: false };
        }



        function getRecommendation(item) {
            if (!item.sellPrice) return { action: 'Unknown', class: 'badge-equal' };
            
            if (!item.recycledSellPrice || item.recycledSellPrice === 0) {
                return { action: 'Sell', class: 'badge-sell' };
            }
            
            if (item.recycledSellPrice > item.sellPrice) {
                return { action: 'Recycle', class: 'badge-recycle' };
            } else if (item.recycledSellPrice < item.sellPrice) {
                return { action: 'Sell', class: 'badge-sell' };
            } else {
                return { action: 'Equal', class: 'badge-equal' };
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const itemSearchTerm = document.getElementById('itemSearchBox').value.toLowerCase();
            const recycleSearchTerm = document.getElementById('recycleSearchBox').value.toLowerCase();
            
            tbody.innerHTML = '';
            
            const filteredData = lootData.filter(item => {
                // Filter by item name
                const matchesItemName = !itemSearchTerm || item.name.toLowerCase().includes(itemSearchTerm);
                
                // Filter by recycles to
                const matchesRecyclesTo = !recycleSearchTerm || 
                    item.recyclesToText.toLowerCase().includes(recycleSearchTerm);
                
                return matchesItemName && matchesRecyclesTo;
            });
            
            if (filteredData.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 8;
                cell.innerHTML = '<div class="no-data">No items found</div>';
                return;
            }
            
            filteredData.forEach(item => {
                const row = tbody.insertRow();
                
                // Item name
                const nameCell = row.insertCell();
                const itemLink = item.link ? `${item.link}` : '#';
                nameCell.innerHTML = `<a href="https://arcraiders.wiki${item.link}" target="_blank" class="item-name">${item.name}</a>`;
                
                // Rarity
                const rarityCell = row.insertCell();
                const rarityClass = `rarity-${(item.rarity || 'common').toLowerCase()}`;
                rarityCell.innerHTML = `<span class="badge badge-rarity ${rarityClass}">${item.rarity || 'Unknown'}</span>`;
                
                // Category
                const categoryCell = row.insertCell();
                categoryCell.textContent = item.category || '-';
                
                // Sell price
                const priceCell = row.insertCell();
                priceCell.innerHTML = item.sellPrice 
                    ? `<span class="price">${item.sellPrice}</span>` 
                    : '-';
                
                // Recycles to
                const recycleCell = row.insertCell();
                if (item.recyclesToText && item.recyclesToText !== '-') {
                    recycleCell.innerHTML = `<div class="recycle-info">${item.recyclesToText}</div>`;
                } else {
                    recycleCell.textContent = '-';
                }
                
                // Recycled value
                const recycledValueCell = row.insertCell();
                recycledValueCell.innerHTML = item.recycledSellPrice 
                    ? `<span class="price">${item.recycledSellPrice}</span>` 
                    : '-';
                
                // Recommendation
                const recommendationCell = row.insertCell();
                const rec = getRecommendation(item);
                recommendationCell.innerHTML = `<span class="badge ${rec.class}">${rec.action}</span>`;
                
                // Keep For (Workbench + Expedition + Quest)
                const keepForCell = row.insertCell();
                const neededInfo = isItemNeededForWorkbench(item.name);
                const expeditionInfo = isItemNeededForExpedition(item.name);
                const badges = [];
                
                if (neededInfo.needed) {
                    badges.push(`<span class="badge badge-needed">${neededInfo.bench} L${neededInfo.level}</span>`);
                }
                
                if (expeditionInfo.needed) {
                    badges.push(`<span class="badge badge-expedition">Expedition P${expeditionInfo.phase}</span>`);
                }
                
                if (item.quest) {
                    badges.push(`<span class="badge badge-quest">Quest</span>`);
                }
                
                if (badges.length > 0) {
                    keepForCell.innerHTML = badges.join(' ');
                } else {
                    keepForCell.textContent = '-';
                }
            });
        }

        // Event listeners
        const itemSearchBox = document.getElementById('itemSearchBox');
        const recycleSearchBox = document.getElementById('recycleSearchBox');
        const clearItemSearch = document.getElementById('clearItemSearch');
        const clearRecycleSearch = document.getElementById('clearRecycleSearch');

        // Toggle clear button visibility
        function updateClearButtons() {
            if (itemSearchBox.value) {
                clearItemSearch.classList.add('visible');
            } else {
                clearItemSearch.classList.remove('visible');
            }
            
            if (recycleSearchBox.value) {
                clearRecycleSearch.classList.add('visible');
            } else {
                clearRecycleSearch.classList.remove('visible');
            }
        }

        itemSearchBox.addEventListener('input', () => {
            updateClearButtons();
            renderTable();
        });

        recycleSearchBox.addEventListener('input', () => {
            updateClearButtons();
            renderTable();
        });

        clearItemSearch.addEventListener('click', () => {
            itemSearchBox.value = '';
            updateClearButtons();
            renderTable();
        });

        clearRecycleSearch.addEventListener('click', () => {
            recycleSearchBox.value = '';
            updateClearButtons();
            renderTable();
        });

        // Initialize
        loadData();
    </script>
</body>
</html>